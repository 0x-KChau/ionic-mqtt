{"version":3,"file":"mqtt-provider.js","sourceRoot":"","sources":["../../src/providers/mqtt-provider.ts"],"names":[],"mappings":"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","sourcesContent":["import { Injectable } from \"@angular/core\";\n\n// mqtt\ndeclare const Paho: any;\ndeclare const document: any;\n\n@Injectable()\n\nexport class MQTTService {\n\n  public client: any;\n  private scripts: any = {};\n  private ScriptStore: Scripts[] = [\n    {\n      name: 'paho_mqtt', src: 'https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.1.0/paho-mqtt.min.js'\n    }\n  ];\n\n  constructor() {\n    this.ScriptStore.forEach((script: any) => {\n        this.scripts[script.name] = {\n            loaded: false,\n            src: script.src\n        };\n    });\n  }\n\n  // load script\n  private _load(...scripts: string[]) {\n      var promises: any[] = [];\n      scripts.forEach((script) => promises.push(this._loadScript(script)));\n      return Promise.all(promises);\n  }\n\n  private _loadScript(name: string) {\n      return new Promise((resolve, reject) => {\n          //resolve if already loaded\n          if (this.scripts[name].loaded) {\n              resolve({name, loaded: true, status: 'Already Loaded'});\n          }\n          else {\n              //load script\n              let script = document.createElement('script');\n              script.type = 'text/javascript';\n              script.src = this.scripts[name].src;\n              if (script.readyState) {  //IE\n                  script.onreadystatechange = () => {\n                      if (script.readyState === \"loaded\" || script.readyState === \"complete\") {\n                          script.onreadystatechange = null;\n                          this.scripts[name].loaded = true;\n                          resolve({name, loaded: true, status: 'Loaded', script, src: script.src});\n                      }\n                  };\n              } else {  //Others\n                  script.onload = () => {\n                      this.scripts[name].loaded = true;\n                      resolve({name, loaded: true, status: 'Loaded', script, src: script.src});\n                  };\n              }\n              script.onerror = (error: any) => resolve({name, loaded: false, status: 'Loaded'});\n              document.getElementsByTagName('head')[0].appendChild(script);\n          }\n      });\n  }\n\n  // mqtt\n  // Load the paho-mqtt mqtt and create a client instance\n  public loadingMqtt(onConnectionLost, onMessageArrived, TOPIC: string[], MQTT_CONFIG: {\n      host: string,\n      port: number,\n      clientId: string,\n      path?: string,\n    }): any {\n    return this._load('paho_mqtt').then(data => {\n      // set callback handlers\n      this.client = new Paho.Client(MQTT_CONFIG.host, Number(MQTT_CONFIG.port), MQTT_CONFIG.path || \"/mqtt\", MQTT_CONFIG.clientId);\n      this.client.onConnectionLost = onConnectionLost.bind(this);\n      this.client.onMessageArrived = onMessageArrived.bind(this);\n      // client connect and subscribe\n      // console.log(this.client);\n      return this.client.connect({onSuccess: this._onConnect.bind(this, TOPIC)});\n    }).catch(error => {\n      console.log(error);\n    });\n  };\n\n  public publishMessage(topic: string, playload: string, qos?: number, retained?: boolean): void {\n      // console.log('msg, topic', topic, playload);\n      var message = new Paho.Message(playload);\n      message.topic = topic;\n      qos ? message.qos = qos : undefined;\n      qos ? message.retained = retained : undefined;\n      this.client.publish(message);\n    };\n\n\n  public sendMessage(topic: string, playload: string, qos?: number, retained?: boolean): void {\n    // console.log('msg, topic', topic, playload);\n    var message = new Paho.Message(playload);\n    message.topic = topic;\n    qos ? message.qos = qos : undefined;\n    qos ? message.retained = retained : undefined;\n    this.client.send(message);\n  };\n\n  // called when the client connects\n  private _onConnect(topic: string[]) {\n    // Once a connection has been made, make a subscription and send a message.\n    // console.log(\"onConnect\");\n    // subscribe the topic\n    topic.forEach((tp) => {\n      this.client.subscribe(tp);\n    });\n\n    return this.client;\n  }\n}\n\n\ninterface Scripts {\n   name: string;\n   src: string;\n}\n"]}